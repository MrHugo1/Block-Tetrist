<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Block Tetrist - Bonus System Test v1.6.2</title>
<style>
  body { 
    background: #1a1f3a; 
    color: #E8EBF7; 
    font-family: system-ui;
    padding: 20px;
  }
  .test-section {
    background: rgba(43, 51, 92, 0.3);
    padding: 20px;
    margin: 20px 0;
    border-radius: 12px;
    border-left: 4px solid #5de4c7;
  }
  button {
    background: #5de4c7;
    color: #0f1220;
    border: none;
    border-radius: 8px;
    padding: 10px 20px;
    margin: 5px;
    cursor: pointer;
    font-weight: bold;
  }
  .log {
    background: #0f1220;
    padding: 15px;
    border-radius: 8px;
    font-family: monospace;
    font-size: 12px;
    max-height: 300px;
    overflow-y: auto;
    white-space: pre-wrap;
  }
  .status {
    padding: 10px;
    margin: 10px 0;
    border-radius: 8px;
    font-weight: bold;
  }
  .success { background: rgba(93, 228, 199, 0.2); border-left: 4px solid #5de4c7; }
  .error { background: rgba(247, 118, 142, 0.2); border-left: 4px solid #f7768e; }
  .info { background: rgba(51, 154, 240, 0.2); border-left: 4px solid #339af0; }
</style>
</head>
<body>
  <h1>üß™ Block Tetrist - Bonus System Test v1.6.2</h1>
  
  <div class="test-section">
    <h3>üîç Test Status</h3>
    <div id="status" class="status info">Initializing tests...</div>
    <button onclick="runAllTests()">Run All Tests</button>
    <button onclick="clearLog()">Clear Log</button>
  </div>
  
  <div class="test-section">
    <h3>üìä Test Results</h3>
    <div id="results"></div>
  </div>
  
  <div class="test-section">
    <h3>üìù Console Log</h3>
    <div id="log" class="log"></div>
  </div>

<script>
let testResults = [];
let logMessages = [];

function log(message) {
  const timestamp = new Date().toLocaleTimeString();
  const logEntry = `[${timestamp}] ${message}`;
  logMessages.push(logEntry);
  document.getElementById('log').textContent = logMessages.join('\n');
  console.log(logEntry);
}

function updateStatus(message, type = 'info') {
  const status = document.getElementById('status');
  status.textContent = message;
  status.className = `status ${type}`;
}

function addResult(testName, passed, details = '') {
  testResults.push({ name: testName, passed, details });
  const resultsDiv = document.getElementById('results');
  const resultClass = passed ? 'success' : 'error';
  const resultIcon = passed ? '‚úÖ' : '‚ùå';
  resultsDiv.innerHTML += `<div class="status ${resultClass}">${resultIcon} ${testName}: ${passed ? 'PASSED' : 'FAILED'} ${details}</div>`;
}

function clearLog() {
  logMessages = [];
  document.getElementById('log').textContent = '';
}

function testBonusPieceCreation() {
  log('Testing bonus piece creation...');
  
  // Mock bonus pieces array
  let bonusPieces = [];
  
  // Test data
  const testPiece = {
    r: 3,
    c: 4,
    multiplier: 5,
    lifetime: 3,
    color: '#ffd43b'
  };
  
  bonusPieces.push(testPiece);
  
  if(bonusPieces.length === 1 && bonusPieces[0].multiplier === 5) {
    addResult('Bonus Piece Creation', true, 'Successfully created bonus piece with x5 multiplier');
    return true;
  } else {
    addResult('Bonus Piece Creation', false, 'Failed to create bonus piece correctly');
    return false;
  }
}

function testBonusPieceLifetime() {
  log('Testing bonus piece lifetime...');
  
  let bonusPieces = [
    { r: 1, c: 1, multiplier: 2, lifetime: 4, color: '#51cf66' },
    { r: 2, c: 2, multiplier: 7, lifetime: 2, color: '#ff6b6b' }
  ];
  
  const initialCount = bonusPieces.length;
  
  // Decrease lifetimes
  bonusPieces.forEach(piece => piece.lifetime--);
  bonusPieces = bonusPieces.filter(piece => piece.lifetime > 0);
  
  if(bonusPieces.length === 1 && bonusPieces[0].lifetime === 3) {
    addResult('Bonus Piece Lifetime', true, 'Successfully decreased lifetime and removed expired piece');
    return true;
  } else {
    addResult('Bonus Piece Lifetime', false, `Expected 1 piece with lifetime 3, got ${bonusPieces.length} pieces`);
    return false;
  }
}

function testBonusMultiplier() {
  log('Testing bonus multiplier calculation...');
  
  const clearedBonusPieces = [
    { multiplier: 2 },
    { multiplier: 5 }
  ];
  
  let totalMultiplier = 1;
  clearedBonusPieces.forEach(piece => {
    totalMultiplier *= piece.multiplier;
  });
  
  if(totalMultiplier === 10) {
    addResult('Bonus Multiplier', true, 'Successfully calculated multiplier: 2 √ó 5 = 10');
    return true;
  } else {
    addResult('Bonus Multiplier', false, `Expected multiplier 10, got ${totalMultiplier}`);
    return false;
  }
}

function testBonusColorCoding() {
  log('Testing bonus color coding...');
  
  function getBonusColor(multiplier) {
    if(multiplier <= 3) return "#51cf66";      // Green for x2, x3
    else if(multiplier <= 5) return "#ffd43b"; // Yellow for x4, x5
    else return "#ff6b6b";                      // Red for x6, x7
  }
  
  const testCases = [
    { multiplier: 2, expectedColor: "#51cf66" },
    { multiplier: 5, expectedColor: "#ffd43b" },
    { multiplier: 7, expectedColor: "#ff6b6b" }
  ];
  
  let allPassed = true;
  testCases.forEach(testCase => {
    const actualColor = getBonusColor(testCase.multiplier);
    if(actualColor !== testCase.expectedColor) {
      log(`Color test failed for x${testCase.multiplier}: expected ${testCase.expectedColor}, got ${actualColor}`);
      allPassed = false;
    }
  });
  
  if(allPassed) {
    addResult('Bonus Color Coding', true, 'All color codes match expected values');
    return true;
  } else {
    addResult('Bonus Color Coding', false, 'Some color codes do not match expected values');
    return false;
  }
}

function testBonusSpawnLogic() {
  log('Testing bonus spawn logic...');
  
  // Mock board state
  const BOARD_SIZE = 8;
  let grid = Array(BOARD_SIZE).fill(0).map(() => Array(BOARD_SIZE).fill(0));
  
  // Place some pieces on the board
  grid[3][3] = 1;
  grid[4][4] = 1;
  grid[5][5] = 1;
  
  // Mock durable pieces
  let durablePieces = [
    { r: 2, c: 2, durability: 3 }
  ];
  
  // Mock existing bonus pieces
  let bonusPieces = [
    { r: 1, c: 1, multiplier: 3, lifetime: 2 }
  ];
  
  function isDurablePiece(r, c) {
    return durablePieces.some(piece => piece.r === r && piece.c === c);
  }
  
  function isBonusPiece(r, c) {
    return bonusPieces.some(piece => piece.r === r && piece.c === c);
  }
  
  // Find available positions for bonus spawn
  let availablePositions = [];
  for(let r = 0; r < BOARD_SIZE; r++) {
    for(let c = 0; c < BOARD_SIZE; c++) {
      if((grid[r][c] || isDurablePiece(r, c)) && !isBonusPiece(r, c)) {
        availablePositions.push({r: r, c: c});
      }
    }
  }
  
  log(`Found ${availablePositions.length} available positions for bonus spawn`);
  
  if(availablePositions.length >= 3) {
    addResult('Bonus Spawn Logic', true, `Found ${availablePositions.length} valid spawn positions`);
    return true;
  } else {
    addResult('Bonus Spawn Logic', false, `Expected at least 3 spawn positions, got ${availablePositions.length}`);
    return false;
  }
}

function runAllTests() {
  log('Starting comprehensive bonus system tests...');
  testResults = [];
  document.getElementById('results').innerHTML = '';
  
  updateStatus('Running tests...', 'info');
  
  // Run all tests
  const tests = [
    testBonusPieceCreation,
    testBonusPieceLifetime,
    testBonusMultiplier,
    testBonusColorCoding,
    testBonusSpawnLogic
  ];
  
  let passedTests = 0;
  tests.forEach(test => {
    try {
      if(test()) passedTests++;
    } catch(error) {
      log(`Test ${test.name} failed with error: ${error.message}`);
      addResult(test.name, false, `Error: ${error.message}`);
    }
  });
  
  const totalTests = tests.length;
  const successRate = (passedTests / totalTests) * 100;
  
  log(`Tests completed: ${passedTests}/${totalTests} passed (${successRate.toFixed(1)}%)`);
  
  if(passedTests === totalTests) {
    updateStatus(`All tests passed! (${passedTests}/${totalTests})`, 'success');
  } else {
    updateStatus(`${passedTests}/${totalTests} tests passed`, 'error');
  }
}

// Auto-run tests on page load
window.addEventListener('load', () => {
  log('Bonus System Test Suite v1.6.2 loaded');
  log('Ready to test the following components:');
  log('- Bonus piece creation and management');
  log('- Lifetime system');
  log('- Multiplier calculations');
  log('- Color coding');
  log('- Spawn logic');
  updateStatus('Ready to run tests', 'info');
});
</script>
</body>
</html>
